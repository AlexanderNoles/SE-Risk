<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>World Conquest: Assets/Mirror/Components/PredictedRigidbody/PredictedRigidbody.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">World Conquest
   </div>
   <div id="projectbrief">Implementation of the Risk board game for our Software Engineering module.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_predicted_rigidbody_8cs_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">PredictedRigidbody.cs</div></div>
</div><!--header-->
<div class="contents">
<a href="_predicted_rigidbody_8cs.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">// PredictedRigidbody which stores &amp; indidvidually rewinds history per Rigidbody.</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">//</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">// This brings significant performance savings because:</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">// - if a scene has 1000 objects</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment">// - and a player interacts with say 3 objects at a time</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">// - Physics.Simulate() would resimulate 1000 objects</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">// - where as this component only resimulates the 3 changed objects</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">//</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">// The downside is that history rewinding is done manually via Vector math,</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">// instead of real physics. It&#39;s not 100% correct - but it sure is fast!</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="keyword">using </span>System;</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="keyword">using </span>System.Collections.Generic;</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="keyword">using </span>UnityEngine;</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span> </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespace_mirror.html">Mirror</a></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>{</div>
<div class="foldopen" id="foldopen00017" data-start="{" data-end="};">
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno"><a class="line" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">   17</a></span>    <span class="keyword">public</span> <span class="keyword">enum</span> <a class="code hl_enumeration" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">CorrectionMode</a></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span>    {</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>        <a class="code hl_enumvalue" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cca5d5b78699e57104f2fa03bbdf7b9197b">Set</a>,               <span class="comment">// rigidbody.position/rotation = ...</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>        <a class="code hl_enumvalue" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cca6bc362dbf494c61ea117fe3c71ca48a5">Move</a>,              <span class="comment">// rigidbody.MovePosition/Rotation</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>    }</div>
</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span> </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    <span class="comment">// [RequireComponent(typeof(Rigidbody))] &lt;- RB is moved out at runtime, can&#39;t require it.</span></div>
<div class="foldopen" id="foldopen00024" data-start="{" data-end="};">
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html">   24</a></span>    <span class="keyword">public</span> <span class="keyword">class </span><a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody.html">PredictedRigidbody</a> : <a class="code hl_class" href="class_mirror_1_1_network_behaviour.html">NetworkBehaviour</a></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>    {</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Transform</a> tf; <span class="comment">// this component is performance critical. cache .transform getter!</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">   27</a></span>        <span class="keyword">protected</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Rigidbody</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>; <span class="comment">// always valid, even while moved onto the ghost.</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> lastPosition;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>        <span class="comment">// motion smoothing happen on-demand, because it requires moving physics components to another GameObject.</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>        <span class="comment">// this only starts at a given velocity and ends when stopped moving.</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>        <span class="comment">// to avoid constant on/off/on effects, it also stays on for a minimum time.</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>        [Header(<span class="stringliteral">&quot;Motion Smoothing&quot;</span>)]</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Smoothing via Ghost-following only happens on demand, while moving with a minimum velocity.&quot;</span>)]</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#aef2f46ee84b63441be12cc9decbd04f0">   35</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#aef2f46ee84b63441be12cc9decbd04f0">motionSmoothingVelocityThreshold</a> = 0.1f;</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#adc9aa75aa188156854ec99877a0e96cc">   36</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#adc9aa75aa188156854ec99877a0e96cc">motionSmoothingAngularVelocityThreshold</a> = 0.1f;</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a8fed6c6001716793e550247258c434fd">   37</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a8fed6c6001716793e550247258c434fd">motionSmoothingTimeTolerance</a> = 0.5f;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>        <span class="keywordtype">double</span> motionSmoothingLastMovedTime;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span> </div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>        <span class="comment">// client keeps state history for correction &amp; reconciliation.</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>        <span class="comment">// this needs to be a SortedList because we need to be able to insert inbetween.</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>        <span class="comment">// RingBuffer would be faster iteration, but can&#39;t do insertions.</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>        [Header(<span class="stringliteral">&quot;State History&quot;</span>)]</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">   44</a></span>        <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">stateHistoryLimit</a> = 32; <span class="comment">// 32 x 50 ms = 1.6 seconds is definitely enough</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">readonly</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">SortedList&lt;double, RigidbodyState&gt;</a> stateHistory = <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">SortedList&lt;double, RigidbodyState&gt;</a>();</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#abe59d76bbe0604bbc53de7fc371bd035">   46</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#abe59d76bbe0604bbc53de7fc371bd035">recordInterval</a> = 0.050f;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span> </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;(Optional) performance optimization where FixedUpdate.RecordState() only inserts state into history if the state actually changed.\nThis is generally a good idea.&quot;</span>)]</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a26bc336e1f0d219c2a7a0e956b9ec7e9">   49</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a26bc336e1f0d219c2a7a0e956b9ec7e9">onlyRecordChanges</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span> </div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;(Optional) performance optimization where received state is compared to the LAST recorded state first, before sampling the whole history.\n\nThis can save significant traversal overhead for idle objects with a tiny chance of missing corrections for objects which revisisted the same position in the recent history twice.&quot;</span>)]</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#accaf0a01fabce1bf8de5e801923ed7b7">   52</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#accaf0a01fabce1bf8de5e801923ed7b7">compareLastFirst</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span> </div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>        [Header(<span class="stringliteral">&quot;Reconciliation&quot;</span>)]</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Correction threshold in meters. For example, 0.1 means that if the client is off by more than 10cm, it gets corrected.&quot;</span>)]</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">   56</a></span>        <span class="keyword">public</span> <span class="keywordtype">double</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">positionCorrectionThreshold</a> = 0.10;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Correction threshold in degrees. For example, 5 means that if the client is off by more than 5 degrees, it gets corrected.&quot;</span>)]</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">   58</a></span>        <span class="keyword">public</span> <span class="keywordtype">double</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">rotationCorrectionThreshold</a> = 5;</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span> </div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Applying server corrections one frame ahead gives much better results. We don&#39;t know why yet, so this is an option for now.&quot;</span>)]</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#ab66167ae8946ea0487a06118cd96b102">   61</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ab66167ae8946ea0487a06118cd96b102">oneFrameAhead</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span> </div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>        [Header(<span class="stringliteral">&quot;Smoothing&quot;</span>)]</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Configure how to apply the corrected state.&quot;</span>)]</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a37d15d3015751972aaa28e129ca2fceb">   65</a></span>        <span class="keyword">public</span> <a class="code hl_enumeration" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">CorrectionMode</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a37d15d3015751972aaa28e129ca2fceb">correctionMode</a> = <a class="code hl_enumeration" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">CorrectionMode</a>.Move;</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span> </div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Snap to the server state directly when velocity is &lt; threshold. This is useful to reduce jitter/fighting effects before coming to rest.\nNote this applies position, rotation and velocity(!) so it&#39;s still smooth.&quot;</span>)]</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a0f940c8a77f7c4d8f0874f44013be8cd">   68</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a0f940c8a77f7c4d8f0874f44013be8cd">snapThreshold</a> = 2; <span class="comment">// 0.5 has too much fighting-at-rest, 2 seems ideal.</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span> </div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>        [Header(<span class="stringliteral">&quot;Visual Interpolation&quot;</span>)]</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;After creating the visual interpolation object, keep showing the original Rigidbody with a ghost (transparent) material for debugging.&quot;</span>)]</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#af6f4eaf410feb856ddb6dd3d268acebc">   72</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#af6f4eaf410feb856ddb6dd3d268acebc">showGhost</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Physics components are moved onto a ghost object beyond this threshold. Main object visually interpolates to it.&quot;</span>)]</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#aab15a1bbe0c3650fda416a9762a7e077">   74</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#aab15a1bbe0c3650fda416a9762a7e077">ghostVelocityThreshold</a> = 0.1f;</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span> </div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;After creating the visual interpolation object, replace this object&#39;s renderer materials with the ghost (ideally transparent) material.&quot;</span>)]</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#abb5e093726a09cab3d11ad3b5de74dd7">   77</a></span>        <span class="keyword">public</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Material</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#abb5e093726a09cab3d11ad3b5de74dd7">localGhostMaterial</a>;</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#aa45dcf59c72f261b3a99851e114725e1">   78</a></span>        <span class="keyword">public</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Material</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#aa45dcf59c72f261b3a99851e114725e1">remoteGhostMaterial</a>;</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span> </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;How fast to interpolate to the target position, relative to how far we are away from it.\nHigher value will be more jitter but sharper moves, lower value will be less jitter but a little too smooth / rounded moves.&quot;</span>)]</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a451891693927acf67bde95796ff162aa">   81</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a451891693927acf67bde95796ff162aa">positionInterpolationSpeed</a> = 15; <span class="comment">// 10 is a little too low for billiards at least</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a94b10093bf267fa52ed3b760932b9ff0">   82</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a94b10093bf267fa52ed3b760932b9ff0">rotationInterpolationSpeed</a> = 10;</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span> </div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Teleport if we are further than &#39;multiplier x collider size&#39; behind.&quot;</span>)]</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#acc83bd1d3591446eb7b72774fb59a0bc">   85</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#acc83bd1d3591446eb7b72774fb59a0bc">teleportDistanceMultiplier</a> = 10;</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span> </div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>        [Header(<span class="stringliteral">&quot;Bandwidth&quot;</span>)]</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>        [<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Tooltip</a>(<span class="stringliteral">&quot;Reduce sends while velocity==0. Client&#39;s objects may slightly move due to gravity/physics, so we still want to send corrections occasionally even if an object is idle on the server the whole time.&quot;</span>)]</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a05655dd23d2f05cdae465414bb141ab0">   89</a></span>        <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a05655dd23d2f05cdae465414bb141ab0">reduceSendsWhileIdle</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span> </div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>        [Header(<span class="stringliteral">&quot;Debugging&quot;</span>)]</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a9b5380d587def5e6ce8e0307811b16ad">   92</a></span>        <span class="keyword">public</span> <span class="keywordtype">float</span> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a9b5380d587def5e6ce8e0307811b16ad">lineTime</a> = 10;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span> </div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>        <span class="comment">// Rigidbody &amp; Collider are moved out into a separate object.</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>        <span class="comment">// this way the visual object can smoothly follow.</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">   96</a></span>        <span class="keyword">protected</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GameObject</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>        <span class="comment">// protected Transform physicsCopyTransform; // caching to avoid GetComponent</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>        <span class="comment">// protected Rigidbody physicsCopyRigidbody =&gt; rb; // caching to avoid GetComponent</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>        <span class="comment">// protected Collider physicsCopyCollider;   // caching to avoid GetComponent</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>        <span class="keywordtype">float</span> smoothFollowThreshold; <span class="comment">// caching to avoid calculation in LateUpdate</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span> </div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>        <span class="comment">// we also create one extra ghost for the exact known server state.</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">  103</a></span>        <span class="keyword">protected</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GameObject</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a>;</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span> </div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>        <span class="comment">// joints</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> initialPosition;</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> initialRotation;</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>        <span class="comment">// Vector3 initialScale; // don&#39;t change scale for now. causes issues with parenting.</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span> </div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>        <span class="keywordtype">void</span> Awake()</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>        {</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>            tf = transform;</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GetComponent&lt;Rigidbody&gt;</a>();</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> == <span class="keyword">null</span>) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">InvalidOperationException</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;Prediction: {name} is missing a Rigidbody component.&quot;</span>);</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span> </div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>            <span class="comment">// cache some threshold to avoid calculating them in LateUpdate</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>            <span class="keywordtype">float</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">colliderSize</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GetComponentInChildren&lt;Collider&gt;</a>().bounds.size.magnitude;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>            smoothFollowThreshold = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">colliderSize</a> * <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#acc83bd1d3591446eb7b72774fb59a0bc">teleportDistanceMultiplier</a>;</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span> </div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>            <span class="comment">// cache initial position/rotation/scale to be used when moving physics components (configurable joints&#39; range of motion)</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>            initialPosition = tf.position;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>            initialRotation = tf.rotation;</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>            <span class="comment">// initialScale = tf.localScale;</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>        }</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span> </div>
<div class="foldopen" id="foldopen00126" data-start="{" data-end="}">
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a6138574f8eaee70b94d46068ba86aa6c">  126</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a6138574f8eaee70b94d46068ba86aa6c">CopyRenderersAsGhost</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GameObject</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">destination</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Material</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">material</a>)</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>        {</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>            <span class="comment">// find the MeshRenderer component, which sometimes is on a child.</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshRenderer</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshRenderer</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GetComponentInChildren&lt;MeshRenderer&gt;</a>(<span class="keyword">true</span>);</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshFilter</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshFilter</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GetComponentInChildren&lt;MeshFilter&gt;</a>(<span class="keyword">true</span>);</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>            <span class="keywordflow">if</span> (<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshRenderer</a> != <span class="keyword">null</span> &amp;&amp; <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshFilter</a> != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>            {</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>                <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshFilter</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">meshFilter</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">destination</a>.AddComponent&lt;<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshFilter</a>&gt;();</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>                meshFilter.mesh = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshFilter</a>.mesh;</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>                <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshRenderer</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">meshRenderer</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">destination</a>.AddComponent&lt;<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">MeshRenderer</a>&gt;();</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>                meshRenderer.material = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshRenderer</a>.material;</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span> </div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>                <span class="comment">// renderers often have multiple materials. copy all.</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>                <span class="keywordflow">if</span> (<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshRenderer</a>.materials != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>                {</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>                    <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Material</a>[] <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">materials</a> = <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Material</a>[<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">originalMeshRenderer</a>.materials.Length];</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>                    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">i</a> = 0; <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">i</a> &lt; <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">materials</a>.Length; ++<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">i</a>)</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>                    {</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>                        <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">materials</a>[<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">i</a>] = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">material</a>;</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>                    }</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>                    meshRenderer.materials = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">materials</a>; <span class="comment">// need to reassign to see it in effect</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>                }</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>            }</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>            <span class="comment">// if we didn&#39;t find a renderer, show a warning</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>            <span class="keywordflow">else</span> <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.LogWarning(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;PredictedRigidbody: {name} found no renderer to copy onto the visual object. If you are using a custom setup, please overwrite PredictedRigidbody.CreateVisualCopy().&quot;</span>);</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>        }</div>
</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span> </div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>        <span class="comment">// instantiate a physics-only copy of the gameobject to apply corrections.</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>        <span class="comment">// this way the main visual object can smoothly follow.</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>        <span class="comment">// it&#39;s best to separate the physics instead of separating the renderers.</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>        <span class="comment">// some projects have complex rendering / animation setups which we can&#39;t touch.</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>        <span class="comment">// besides, Rigidbody+Collider are two components, where as renders may be many.</span></div>
<div class="foldopen" id="foldopen00159" data-start="{" data-end="}">
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a3ce5d2452b149ad47d6303773dd5e996">  159</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a3ce5d2452b149ad47d6303773dd5e996">CreateGhosts</a>()</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>        {</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>            <span class="comment">// skip if host mode or already separated</span></div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_mirror_1_1_network_behaviour.html#a6a65dec5ade34544074c2f997932e17a">isServer</a> || <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a> != <span class="keyword">null</span>) <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span> </div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>            <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.Log(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;Separating Physics for {name}&quot;</span>);</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span> </div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>            <span class="comment">// create an empty GameObject with the same name + _Physical</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>            <span class="comment">// it&#39;s important to copy world position/rotation/scale, not local!</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>            <span class="comment">// because the original object may be a child of another.</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>            <span class="comment">//</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>            <span class="comment">// for example:</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>            <span class="comment">//    parent (scale=1.5)</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>            <span class="comment">//      child (scale=0.5)</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>            <span class="comment">//</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>            <span class="comment">// if we copy localScale then the copy has scale=0.5, where as the</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>            <span class="comment">// original would have a global scale of ~1.0.</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a> = <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GameObject</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;{name}_Physical&quot;</span>);</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>            <span class="comment">// assign the same Layer for the physics copy.</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>            <span class="comment">// games may use a custom physics collision matrix, layer matters.</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>            physicsCopy.layer = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">gameObject</a>.layer;</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span> </div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>            <span class="comment">// add the PredictedRigidbodyPhysical component</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>            <a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">PredictedRigidbodyPhysicsGhost</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsGhostRigidbody</a> = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>.AddComponent&lt;<a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">PredictedRigidbodyPhysicsGhost</a>&gt;();</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>            physicsGhostRigidbody.target = tf;</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span> </div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>            <span class="comment">// when moving (Configurable)Joints, their range of motion is</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>            <span class="comment">// relative to the initial position. if we move them after the</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>            <span class="comment">// GameObject rotated, the range of motion is wrong.</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>            <span class="comment">// the easiest solution is to move to initial position,</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>            <span class="comment">// then move physics components, then move back.</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>            <span class="comment">// =&gt; remember previous</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> position = tf.position;</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> rotation = tf.rotation;</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>            <span class="comment">// Vector3 scale = tf.localScale; // don&#39;t change scale for now. causes issues with parenting.</span></div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>            <span class="comment">// =&gt; reset to initial</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>            physicsGhostRigidbody.transform.position = tf.position = initialPosition;</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>            physicsGhostRigidbody.transform.rotation = tf.rotation = initialRotation;</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>            physicsGhostRigidbody.transform.localScale = tf.lossyScale;<span class="comment">// world scale! // = initialScale; // don&#39;t change scale for now. causes issues with parenting.</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>            <span class="comment">// =&gt; move physics components</span></div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>            PredictionUtils.MovePhysicsComponents(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">gameObject</a>, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>);</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>            <span class="comment">// =&gt; reset previous</span></div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>            physicsGhostRigidbody.transform.position = tf.position = position;</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>            physicsGhostRigidbody.transform.rotation = tf.rotation = rotation;</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>            <span class="comment">//physicsGhostRigidbody.transform.localScale = tf.lossyScale; // world scale! //= scale; // don&#39;t change scale for now. causes issues with parenting.</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span> </div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>            <span class="comment">// show ghost by copying all renderers / materials with ghost material applied</span></div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#af6f4eaf410feb856ddb6dd3d268acebc">showGhost</a>)</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>            {</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>                <span class="comment">// one for the locally predicted rigidbody</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>                <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a6138574f8eaee70b94d46068ba86aa6c">CopyRenderersAsGhost</a>(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#abb5e093726a09cab3d11ad3b5de74dd7">localGhostMaterial</a>);</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span> </div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>                <span class="comment">// one for the latest remote state for comparison</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>                <span class="comment">// it&#39;s important to copy world position/rotation/scale, not local!</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>                <span class="comment">// because the original object may be a child of another.</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>                <span class="comment">//</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>                <span class="comment">// for example:</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>                <span class="comment">//    parent (scale=1.5)</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>                <span class="comment">//      child (scale=0.5)</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>                <span class="comment">//</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>                <span class="comment">// if we copy localScale then the copy has scale=0.5, where as the</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>                <span class="comment">// original would have a global scale of ~1.0.</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a> = <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GameObject</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;{name}_Remote&quot;</span>);</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>                remoteCopy.transform.position = tf.position;     <span class="comment">// world position!</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>                remoteCopy.transform.rotation = tf.rotation;     <span class="comment">// world rotation!</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>                remoteCopy.transform.localScale = tf.lossyScale; <span class="comment">// world scale!</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>                <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a6138574f8eaee70b94d46068ba86aa6c">CopyRenderersAsGhost</a>(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a>, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#aa45dcf59c72f261b3a99851e114725e1">remoteGhostMaterial</a>);</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>            }</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span> </div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>            <span class="comment">// assign our Rigidbody reference to the ghost</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>.GetComponent&lt;<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Rigidbody</a>&gt;();</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>        }</div>
</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span> </div>
<div class="foldopen" id="foldopen00233" data-start="{" data-end="}">
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a93a51eb03d3e2ee26abb482e1cc934a1">  233</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a93a51eb03d3e2ee26abb482e1cc934a1">DestroyGhosts</a>()</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>        {</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>            <span class="comment">// move the copy&#39;s Rigidbody back onto self.</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>            <span class="comment">// important for scene objects which may be reused for AOI spawn/despawn.</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>            <span class="comment">// otherwise next time they wouldn&#39;t have a collider anymore.</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a> != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>            {</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>                <span class="comment">// when moving (Configurable)Joints, their range of motion is</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>                <span class="comment">// relative to the initial position. if we move them after the</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>                <span class="comment">// GameObject rotated, the range of motion is wrong.</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>                <span class="comment">// the easiest solution is to move to initial position,</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>                <span class="comment">// then move physics components, then move back.</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>                <span class="comment">// =&gt; remember previous</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>                <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> position = tf.position;</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>                <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> rotation = tf.rotation;</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>                <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> scale = tf.localScale;</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>                <span class="comment">// =&gt; reset to initial</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>                physicsCopy.transform.position = tf.position = initialPosition;</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>                physicsCopy.transform.rotation = tf.rotation = initialRotation;</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>                physicsCopy.transform.localScale = tf.lossyScale;<span class="comment">// = initialScale;</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>                <span class="comment">// =&gt; move physics components</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>                PredictionUtils.MovePhysicsComponents(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">gameObject</a>);</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>                <span class="comment">// =&gt; reset previous</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>                tf.position = position;</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>                tf.rotation = rotation;</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>                tf.localScale = scale;</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span> </div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>                <span class="comment">// when moving components back, we need to undo the joints initial-delta rotation that we added.</span></div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>                Destroy(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>);</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span> </div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>                <span class="comment">// reassign our Rigidbody reference</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">GetComponent&lt;Rigidbody&gt;</a>();</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>            }</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span> </div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>            <span class="comment">// simply destroy the remote copy</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a> != <span class="keyword">null</span>) Destroy(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a>);</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>        }</div>
</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span> </div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>        <span class="comment">// this shows in profiler LateUpdates! need to make this as fast as possible!</span></div>
<div class="foldopen" id="foldopen00272" data-start="{" data-end="}">
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#ab377b2ce608f0727fced6f787b738df2">  272</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#ab377b2ce608f0727fced6f787b738df2">SmoothFollowPhysicsCopy</a>()</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>        {</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>            <span class="comment">// hard follow:</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>            <span class="comment">// tf.position = physicsCopyCollider.position;</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>            <span class="comment">// tf.rotation = physicsCopyCollider.rotation;</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span> </div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>            <span class="comment">// ORIGINAL VERSION: CLEAN AND SIMPLE</span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>            <span class="comment">/*</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span><span class="comment">            // if we are further than N colliders sizes behind, then teleport</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="comment">            float colliderSize = physicsCopyCollider.bounds.size.magnitude;</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span><span class="comment">            float threshold = colliderSize * teleportDistanceMultiplier;</span></div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span><span class="comment">            float distance = Vector3.Distance(tf.position, physicsCopyRigidbody.position);</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span><span class="comment">            if (distance &gt; threshold)</span></div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="comment">            {</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span><span class="comment">                tf.position = physicsCopyRigidbody.position;</span></div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span><span class="comment">                tf.rotation = physicsCopyRigidbody.rotation;</span></div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span><span class="comment">                Debug.Log($&quot;[PredictedRigidbody] Teleported because distance to physics copy = {distance:F2} &gt; threshold {threshold:F2}&quot;);</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span><span class="comment">                return;</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span><span class="comment">            }</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span><span class="comment"></span> </div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span><span class="comment">            // smoothly interpolate to the target position.</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span><span class="comment">            // speed relative to how far away we are</span></div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span><span class="comment">            float positionStep = distance * positionInterpolationSpeed;</span></div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span><span class="comment">            tf.position = Vector3.MoveTowards(tf.position, physicsCopyRigidbody.position, positionStep * Time.deltaTime);</span></div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span><span class="comment"></span> </div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span><span class="comment">            // smoothly interpolate to the target rotation.</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="comment">            // Quaternion.RotateTowards doesn&#39;t seem to work at all, so let&#39;s use SLerp.</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="comment">            tf.rotation = Quaternion.Slerp(tf.rotation, physicsCopyRigidbody.rotation, rotationInterpolationSpeed * Time.deltaTime);</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="comment">            */</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span> </div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>            <span class="comment">// FAST VERSION: this shows in profiler a lot, so cache EVERYTHING!</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>            tf.GetPositionAndRotation(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">currentPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">currentRotation</a>); <span class="comment">// faster than tf.position + tf.rotation</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsPosition</a> = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.position;</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsRotation</a> = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.rotation;</div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>            <span class="keywordtype">float</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">deltaTime</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Time</a>.deltaTime;</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span> </div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>            <span class="keywordtype">float</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">distance</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a>.Distance(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">currentPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsPosition</a>);</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>            <span class="keywordflow">if</span> (<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">distance</a> &gt; smoothFollowThreshold)</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>            {</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>                tf.SetPositionAndRotation(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsRotation</a>); <span class="comment">// faster than .position and .rotation manually</span></div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>                <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.Log(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">$</a><span class="stringliteral">&quot;[PredictedRigidbody] Teleported because distance to physics copy = {distance:F2} &gt; threshold {smoothFollowThreshold:F2}&quot;</span>);</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>            }</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span> </div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>            <span class="comment">// smoothly interpolate to the target position.</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>            <span class="comment">// speed relative to how far away we are.</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>            <span class="comment">// =&gt; speed increases by distance² because the further away, the</span></div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>            <span class="comment">//    sooner we need to catch the fuck up</span></div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>            <span class="comment">// float positionStep = (distance * distance) * interpolationSpeed;</span></div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>            <span class="keywordtype">float</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">positionStep</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">distance</a> * <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a451891693927acf67bde95796ff162aa">positionInterpolationSpeed</a>;</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">newPosition</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a>.MoveTowards(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">currentPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">positionStep</a> * <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">deltaTime</a>);</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span> </div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>            <span class="comment">// smoothly interpolate to the target rotation.</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>            <span class="comment">// Quaternion.RotateTowards doesn&#39;t seem to work at all, so let&#39;s use SLerp.</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>            <span class="comment">// Quaternions always need to be normalized in order to be a valid rotation after operations</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">newRotation</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a>.Slerp(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">currentRotation</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">physicsRotation</a>, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a94b10093bf267fa52ed3b760932b9ff0">rotationInterpolationSpeed</a> * <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">deltaTime</a>).normalized;</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span> </div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>            <span class="comment">// assign position and rotation together. faster than accessing manually.</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>            tf.SetPositionAndRotation(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">newPosition</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">newRotation</a>);</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>        }</div>
</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span> </div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>        <span class="comment">// destroy visual copy only in OnStopClient().</span></div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>        <span class="comment">// OnDestroy() wouldn&#39;t be called for scene objects that are only disabled instead of destroyed.</span></div>
<div class="foldopen" id="foldopen00335" data-start="{" data-end="}">
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a6ddaaa078711aee9b5b53aea8c72713c">  335</a></span>        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a6ddaaa078711aee9b5b53aea8c72713c">OnStopClient</a>()</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>        {</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>            <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a93a51eb03d3e2ee26abb482e1cc934a1">DestroyGhosts</a>();</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>        }</div>
</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span> </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>        <span class="keywordtype">void</span> UpdateServer()</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>        {</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>            <span class="comment">// bandwidth optimization while idle.</span></div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a05655dd23d2f05cdae465414bb141ab0">reduceSendsWhileIdle</a>)</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>            {</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>                <span class="comment">// while moving, always sync every frame for immediate corrections.</span></div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>                <span class="comment">// while idle, only sync once per second.</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>                <span class="comment">//</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>                <span class="comment">// we still need to sync occasionally because objects on client</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>                <span class="comment">// may still slide or move slightly due to gravity, physics etc.</span></div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>                <span class="comment">// and those still need to get corrected if not moving on server.</span></div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>                <span class="comment">//</span></div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>                <span class="comment">// TODO</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>                <span class="comment">// next round of optimizations: if client received nothing for 1s,</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>                <span class="comment">// force correct to last received state. then server doesn&#39;t need</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>                <span class="comment">// to send once per second anymore.</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>                <a class="code hl_variable" href="class_mirror_1_1_network_behaviour.html#a94dbe38f0930d3bbde326d0eed7b6f83">syncInterval</a> = <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">IsMoving</a>() ? 0 : 1;</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>            }</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span> </div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>            <span class="comment">// always set dirty to always serialize in next sync interval.</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>            <a class="code hl_function" href="class_mirror_1_1_network_behaviour.html#aa54c7efe36af763380824091dd7e6159">SetDirty</a>();</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>        }</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span> </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>        <span class="comment">// movement detection is virtual, in case projects want to use other methods.</span></div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">  364</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">IsMoving</a>() =&gt;</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>            predictedRigidbody.velocity.magnitude &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#aef2f46ee84b63441be12cc9decbd04f0">motionSmoothingVelocityThreshold</a> ||</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>            predictedRigidbody.angularVelocity.magnitude &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#adc9aa75aa188156854ec99877a0e96cc">motionSmoothingAngularVelocityThreshold</a>;</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span> </div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>        <span class="keywordtype">void</span> UpdateGhosting()</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>        {</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>            <span class="comment">// client only uses ghosts on demand while interacting.</span></div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>            <span class="comment">// this way 1000 GameObjects don&#39;t need +1000 Ghost GameObjects all the time!</span></div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span> </div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>            <span class="comment">// no ghost at the moment</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a> == <span class="keyword">null</span>)</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>            {</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>                <span class="comment">// faster than velocity threshold? then create the ghosts.</span></div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>                <span class="comment">// with 10% buffer zone so we don&#39;t flip flop all the time.</span></div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>                <span class="keywordflow">if</span> (<a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">IsMoving</a>())</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>                {</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>                    <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a3ce5d2452b149ad47d6303773dd5e996">CreateGhosts</a>();</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>                    <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a358f16bc1a6a3b03b7c2633388ad3725">OnBeginPrediction</a>();</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>                }</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>            }</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>            <span class="comment">// ghosting at the moment</span></div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>            {</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>                <span class="comment">// always set last moved time while moving.</span></div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>                <span class="comment">// this way we can avoid on/off/oneffects when  stopping.</span></div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>                <span class="keywordflow">if</span> (<a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">IsMoving</a>())</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>                {</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>                    motionSmoothingLastMovedTime = NetworkTime.time;</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>                }</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>                <span class="comment">// slower than velocity threshold? then destroy the ghosts.</span></div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>                <span class="comment">// with a minimum time since starting to move, to avoid on/off/on effects.</span></div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>                {</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>                    <span class="keywordflow">if</span> (NetworkTime.time &gt;= motionSmoothingLastMovedTime + <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a8fed6c6001716793e550247258c434fd">motionSmoothingTimeTolerance</a>)</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>                    {</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>                        <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a93a51eb03d3e2ee26abb482e1cc934a1">DestroyGhosts</a>();</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>                        <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a74ac82a408e524d80aaf889b76c343b8">OnEndPrediction</a>();</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>                        <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a> = <span class="keyword">null</span>; <span class="comment">// TESTING</span></div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>                    }</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>                }</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>            }</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>        }</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span> </div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>        <span class="keywordtype">void</span> Update()</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>        {</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_mirror_1_1_network_behaviour.html#a6a65dec5ade34544074c2f997932e17a">isServer</a>) UpdateServer();</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_mirror_1_1_network_behaviour.html#abe78215943243c0ee91c2bd9a0057915">isClientOnly</a>) UpdateGhosting();</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>        }</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span> </div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>        <span class="keywordtype">void</span> LateUpdate()</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>        {</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>            <span class="comment">// only follow on client-only, not in server or host mode</span></div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_mirror_1_1_network_behaviour.html#abe78215943243c0ee91c2bd9a0057915">isClientOnly</a> &amp;&amp; <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">physicsCopy</a>) <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#ab377b2ce608f0727fced6f787b738df2">SmoothFollowPhysicsCopy</a>();</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>        }</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span> </div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>        <span class="keywordtype">void</span> FixedUpdate()</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>        {</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>            <span class="comment">// on clients (not host) we record the current state every FixedUpdate.</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>            <span class="comment">// this is cheap, and allows us to keep a dense history.</span></div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>            <span class="keywordflow">if</span> (<a class="code hl_property" href="class_mirror_1_1_network_behaviour.html#abe78215943243c0ee91c2bd9a0057915">isClientOnly</a>)</div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>            {</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>                <span class="comment">// OPTIMIZATION: RecordState() is expensive because it inserts into a SortedList.</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>                <span class="comment">// only record if state actually changed!</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>                <span class="comment">// risks not having up to date states when correcting,</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>                <span class="comment">// but it doesn&#39;t matter since we&#39;ll always compare with the &#39;newest&#39; anyway.</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>                <span class="comment">//</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>                <span class="comment">// we check in here instead of in RecordState() because RecordState() should definitely record if we call it!</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a26bc336e1f0d219c2a7a0e956b9ec7e9">onlyRecordChanges</a>)</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>                {</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>                    <span class="comment">// TODO maybe don&#39;t reuse the correction thresholds?</span></div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>                    tf.GetPositionAndRotation(out Vector3 position, out Quaternion rotation);</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>                    <span class="keywordflow">if</span> (Vector3.Distance(lastRecorded.<a class="code hl_property" href="struct_mirror_1_1_rigidbody_state.html#a3df152c12ab9502420a32603e90bf729">position</a>, position) &lt; <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">positionCorrectionThreshold</a> &amp;&amp;</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>                        Quaternion.Angle(lastRecorded.<a class="code hl_property" href="struct_mirror_1_1_rigidbody_state.html#aa40b806423fc55ce208b7b1ec726edae">rotation</a>, rotation) &lt; <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">rotationCorrectionThreshold</a>)</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>                    {</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>                        <span class="comment">// Debug.Log($&quot;FixedUpdate for {name}: taking optimized early return instead of recording state.&quot;);</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>                        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>                    }</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>                }</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span> </div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>                RecordState();</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>            }</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>        }</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span> </div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>        <span class="comment">// manually store last recorded so we can easily check against this</span></div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>        <span class="comment">// without traversing the SortedList.</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>        RigidbodyState lastRecorded;</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span>        <span class="keywordtype">double</span> lastRecordTime;</div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>        <span class="keywordtype">void</span> RecordState()</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>        {</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>            <span class="comment">// instead of recording every fixedupdate, let&#39;s record in an interval.</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>            <span class="comment">// we don&#39;t want to record every tiny move and correct too hard.</span></div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>            <span class="keywordflow">if</span> (NetworkTime.time &lt; lastRecordTime + <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#abe59d76bbe0604bbc53de7fc371bd035">recordInterval</a>) <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>            lastRecordTime = NetworkTime.time;</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span> </div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>            <span class="comment">// NetworkTime.time is always behind by bufferTime.</span></div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>            <span class="comment">// prediction aims to be on the exact same server time (immediately).</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>            <span class="comment">// use predictedTime to record state, otherwise we would record in the past.</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>            <span class="keywordtype">double</span> predictedTime = NetworkTime.predictedTime;</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span> </div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>            <span class="comment">// FixedUpdate may run twice in the same frame / NetworkTime.time.</span></div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>            <span class="comment">// for now, simply don&#39;t record if already recorded there.</span></div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>            <span class="comment">// previously we checked ContainsKey which is O(logN) for SortedList</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>            <span class="comment">//   if (stateHistory.ContainsKey(predictedTime))</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>            <span class="comment">//       return;</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>            <span class="comment">// instead, simply store the last recorded time and don&#39;t insert if same.</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>            <span class="keywordflow">if</span> (predictedTime == lastRecorded.timestamp) <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span> </div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>            <span class="comment">// keep state history within limit</span></div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>            <span class="keywordflow">if</span> (stateHistory.Count &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">stateHistoryLimit</a>)</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>                stateHistory.RemoveAt(0);</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span> </div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>            <span class="comment">// grab current position/rotation/velocity only once.</span></div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>            <span class="comment">// this is performance critical, avoid calling .transform multiple times.</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>            tf.GetPositionAndRotation(out Vector3 currentPosition, out Quaternion currentRotation); <span class="comment">// faster than accessing .position + .rotation manually</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>            Vector3 currentVelocity = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.velocity;</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>            Vector3 currentAngularVelocity = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.angularVelocity;</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span> </div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>            <span class="comment">// calculate delta to previous state (if any)</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>            Vector3 positionDelta = Vector3.zero;</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>            Vector3 velocityDelta = Vector3.zero;</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>            Vector3 angularVelocityDelta = Vector3.zero;</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>            Quaternion rotationDelta = Quaternion.identity;</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>            <span class="keywordflow">if</span> (stateHistory.Count &gt; 0)</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>            {</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>                RigidbodyState last = stateHistory.Values[stateHistory.Count - 1];</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>                positionDelta = currentPosition - last.position;</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>                velocityDelta = currentVelocity - last.velocity;</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>                <span class="comment">// Quaternions always need to be normalized in order to be valid rotations after operations</span></div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>                rotationDelta = (currentRotation * Quaternion.Inverse(last.rotation)).normalized;</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>                angularVelocityDelta = currentAngularVelocity - last.angularVelocity;</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span> </div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>                <span class="comment">// debug draw the recorded state</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>                <span class="comment">// Debug.DrawLine(last.position, currentPosition, Color.red, lineTime);</span></div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>            }</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span> </div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>            <span class="comment">// create state to insert</span></div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>            RigidbodyState state = <span class="keyword">new</span> RigidbodyState(</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>                predictedTime,</div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>                positionDelta,</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>                currentPosition,</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>                rotationDelta,</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>                currentRotation,</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>                velocityDelta,</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>                currentVelocity,</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>                angularVelocityDelta,</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>                currentAngularVelocity</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>            );</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span> </div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>            <span class="comment">// add state to history</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>            stateHistory.<a class="code hl_function" href="struct_mirror_1_1_grid2_d.html#a05b810f7466b59b26b243d83383d1274">Add</a>(predictedTime, state);</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span> </div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>            <span class="comment">// manually remember last inserted state for faster .Last comparisons</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>            lastRecorded = state;</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>        }</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span> </div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span>        <span class="comment">// optional user callbacks, in case people need to know about events.</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#aebdd7fea91a87e82a1fde56a3ab1f9d9">  520</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#aebdd7fea91a87e82a1fde56a3ab1f9d9">OnSnappedIntoPlace</a>() {}</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#ac51e050040b89552736e77d4f776d5bb">  521</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#ac51e050040b89552736e77d4f776d5bb">OnBeforeApplyState</a>() {}</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a5ebeb25d2575a1bc094d150979328922">  522</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a5ebeb25d2575a1bc094d150979328922">OnCorrected</a>() {}</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a358f16bc1a6a3b03b7c2633388ad3725">  523</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a358f16bc1a6a3b03b7c2633388ad3725">OnBeginPrediction</a>() {} <span class="comment">// when the Rigidbody moved above threshold and we created a ghost</span></div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a74ac82a408e524d80aaf889b76c343b8">  524</a></span>        <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a74ac82a408e524d80aaf889b76c343b8">OnEndPrediction</a>() {}   <span class="comment">// when the Rigidbody came to rest and we destroyed the ghost</span></div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span> </div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>        <span class="keywordtype">void</span> ApplyState(<span class="keywordtype">double</span> timestamp, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> position, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> rotation, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> velocity, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> angularVelocity)</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>        {</div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>            <span class="comment">// fix rigidbodies seemingly dancing in place instead of coming to rest.</span></div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>            <span class="comment">// hard snap to the position below a threshold velocity.</span></div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>            <span class="comment">// this is fine because the visual object still smoothly interpolates to it.</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>            <span class="comment">// =&gt; consider both velocity and angular velocity (in case of Rigidbodies only rotating with joints etc.)</span></div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.velocity.magnitude &lt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a0f940c8a77f7c4d8f0874f44013be8cd">snapThreshold</a> &amp;&amp;</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.angularVelocity.magnitude &lt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a0f940c8a77f7c4d8f0874f44013be8cd">snapThreshold</a>)</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>            {</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>                <span class="comment">// Debug.Log($&quot;Prediction: snapped {name} into place because velocity {predictedRigidbody.velocity.magnitude:F3} &lt;= {snapThreshold:F3}&quot;);</span></div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>                <span class="comment">// apply server state immediately.</span></div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>                <span class="comment">// important to apply velocity as well, instead of Vector3.zero.</span></div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>                <span class="comment">// in case an object is still slightly moving, we don&#39;t want it</span></div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>                <span class="comment">// to stop and start moving again on client - slide as well here.</span></div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>                predictedRigidbody.position = position;</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>                predictedRigidbody.rotation = rotation;</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>                <span class="comment">// projects may keep Rigidbodies as kinematic sometimes. in that case, setting velocity would log an error</span></div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>                <span class="keywordflow">if</span> (!<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.isKinematic)</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>                {</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>                    predictedRigidbody.velocity = velocity;</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>                    predictedRigidbody.angularVelocity = angularVelocity;</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>                }</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span> </div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>                <span class="comment">// clear history and insert the exact state we just applied.</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>                <span class="comment">// this makes future corrections more accurate.</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>                stateHistory.Clear();</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>                stateHistory.<a class="code hl_function" href="struct_mirror_1_1_grid2_d.html#a05b810f7466b59b26b243d83383d1274">Add</a>(timestamp, <span class="keyword">new</span> RigidbodyState(</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>                    timestamp,</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>                    Vector3.zero,</div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>                    position,</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>                    Quaternion.identity,</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>                    rotation,</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>                    Vector3.zero,</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>                    velocity,</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>                    Vector3.zero,</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>                    angularVelocity</div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>                ));</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span> </div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>                <span class="comment">// user callback</span></div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>                <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#aebdd7fea91a87e82a1fde56a3ab1f9d9">OnSnappedIntoPlace</a>();</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>            }</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span> </div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>            <span class="comment">// we have a callback for snapping into place (above).</span></div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>            <span class="comment">// we also need one for corrections without snapping into place.</span></div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>            <span class="comment">// call it before applying pos/rot/vel in case we need to set kinematic etc.</span></div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>            <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#ac51e050040b89552736e77d4f776d5bb">OnBeforeApplyState</a>();</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span> </div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>            <span class="comment">// Rigidbody .position teleports, while .MovePosition interpolates</span></div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>            <span class="comment">// TODO is this a good idea? what about next capture while it&#39;s interpolating?</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a37d15d3015751972aaa28e129ca2fceb">correctionMode</a> == <a class="code hl_enumeration" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">CorrectionMode</a>.Move)</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>            {</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.MovePosition(position);</div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.MoveRotation(rotation);</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>            }</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a37d15d3015751972aaa28e129ca2fceb">correctionMode</a> == <a class="code hl_enumeration" href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">CorrectionMode</a>.Set)</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>            {</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>                predictedRigidbody.position = position;</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>                predictedRigidbody.rotation = rotation;</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>            }</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span> </div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>            <span class="comment">// there&#39;s only one way to set velocity.</span></div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>            <span class="comment">// (projects may keep Rigidbodies as kinematic sometimes. in that case, setting velocity would log an error)</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>            <span class="keywordflow">if</span> (!<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.isKinematic)</div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>            {</div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>                predictedRigidbody.velocity = velocity;</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>                predictedRigidbody.angularVelocity = angularVelocity;</div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>            }</div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>        }</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span> </div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>        <span class="comment">// process a received server state.</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>        <span class="comment">// compares it against our history and applies corrections if needed.</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>        <span class="keywordtype">void</span> OnReceivedState(<span class="keywordtype">double</span> timestamp, RigidbodyState state)</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>        {</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>            <span class="comment">// always update remote state ghost</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a> != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>            {</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>                Transform remoteCopyTransform = <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">remoteCopy</a>.transform;</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>                remoteCopyTransform.SetPositionAndRotation(state.position, state.rotation); <span class="comment">// faster than .position + .rotation setters</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>                remoteCopyTransform.localScale = tf.lossyScale; <span class="comment">// world scale! see CreateGhosts comment.</span></div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>            }</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span> </div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>            <span class="comment">// OPTIONAL performance optimization when comparing idle objects.</span></div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>            <span class="comment">// even idle objects will have a history of ~32 entries.</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>            <span class="comment">// sampling &amp; traversing through them is unnecessarily costly.</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>            <span class="comment">// instead, compare directly against the current rigidbody position!</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>            <span class="comment">// =&gt; this is technically not 100% correct if an object runs in</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>            <span class="comment">//    circles where it may revisit the same position twice.</span></div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>            <span class="comment">// =&gt; but practically, objects that didn&#39;t move will have their</span></div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>            <span class="comment">//    whole history look like the last inserted state.</span></div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>            <span class="comment">// =&gt; comparing against that is free and gives us a significant</span></div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>            <span class="comment">//    performance saving vs. a tiny chance of incorrect results due</span></div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>            <span class="comment">//    to objects running in circles.</span></div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>            <span class="comment">// =&gt; the RecordState() call below is expensive too, so we want to</span></div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>            <span class="comment">//    do this before even recording the latest state. the only way</span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>            <span class="comment">//    to do this (in case last recorded state is too old), is to</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>            <span class="comment">//    compare against live rigidbody.position without any recording.</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>            <span class="comment">//    this is as fast as it gets for skipping idle objects.</span></div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>            <span class="comment">//</span></div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>            <span class="comment">// if this ever causes issues, feel free to disable it.</span></div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#accaf0a01fabce1bf8de5e801923ed7b7">compareLastFirst</a> &amp;&amp;</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>                Vector3.Distance(state.position, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.position) &lt; <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">positionCorrectionThreshold</a> &amp;&amp;</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>                Quaternion.Angle(state.rotation, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.rotation) &lt; <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">rotationCorrectionThreshold</a>)</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>            {</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>                <span class="comment">// Debug.Log($&quot;OnReceivedState for {name}: taking optimized early return!&quot;);</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>            }</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span> </div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>            <span class="comment">// we only capture state every &#39;interval&#39; milliseconds.</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>            <span class="comment">// so the newest entry in &#39;history&#39; may be up to &#39;interval&#39; behind &#39;now&#39;.</span></div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>            <span class="comment">// if there&#39;s no latency, we may receive a server state for &#39;now&#39;.</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>            <span class="comment">// sampling would fail, if we haven&#39;t recorded anything in a while.</span></div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>            <span class="comment">// to solve this, always record the current state when receiving a server state.</span></div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>            RecordState();</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span> </div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>            <span class="comment">// correction requires at least 2 existing states for &#39;before&#39; and &#39;after&#39;.</span></div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>            <span class="comment">// if we don&#39;t have two yet, drop this state and try again next time once we recorded more.</span></div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>            <span class="keywordflow">if</span> (stateHistory.Count &lt; 2) <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span> </div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>            RigidbodyState oldest = stateHistory.Values[0];</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>            RigidbodyState newest = stateHistory.Values[stateHistory.Count - 1];</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span> </div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>            <span class="comment">// edge case: is the state older than the oldest state in history?</span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>            <span class="comment">// this can happen if the client gets so far behind the server</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>            <span class="comment">// that it doesn&#39;t have a recored history to sample from.</span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>            <span class="comment">// in that case, we should hard correct the client.</span></div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>            <span class="comment">// otherwise it could be out of sync as long as it&#39;s too far behind.</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>            <span class="keywordflow">if</span> (state.timestamp &lt; oldest.timestamp)</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>            {</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>                <span class="comment">// when starting, client may only have 2-3 states in history.</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>                <span class="comment">// it&#39;s expected that server states would be behind those 2-3.</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>                <span class="comment">// only show a warning if it&#39;s behind the full history limit!</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>                <span class="keywordflow">if</span> (stateHistory.Count &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">stateHistoryLimit</a>)</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>                    <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.LogWarning($<span class="stringliteral">&quot;Hard correcting client object {name} because the client is too far behind the server. History of size={stateHistory.Count} @ t={timestamp:F3} oldest={oldest.timestamp:F3} newest={newest.timestamp:F3}. This would cause the client to be out of sync as long as it&#39;s behind.&quot;</span>);</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span> </div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>                <span class="comment">// force apply the state</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>                ApplyState(state.timestamp, state.position, state.rotation, state.velocity, state.angularVelocity);</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>            }</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span> </div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>            <span class="comment">// edge case: is it newer than the newest state in history?</span></div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>            <span class="comment">// this can happen if client&#39;s predictedTime predicts too far ahead of the server.</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>            <span class="comment">// in that case, log a warning for now but still apply the correction.</span></div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>            <span class="comment">// otherwise it could be out of sync as long as it&#39;s too far ahead.</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>            <span class="comment">//</span></div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>            <span class="comment">// for example, when running prediction on the same machine with near zero latency.</span></div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>            <span class="comment">// when applying corrections here, this looks just fine on the local machine.</span></div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>            <span class="keywordflow">if</span> (newest.timestamp &lt; state.timestamp)</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>            {</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>                <span class="comment">// the correction is for a state in the future.</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>                <span class="comment">// we clamp it to &#39;now&#39;.</span></div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>                <span class="comment">// but only correct if off by threshold.</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span>                <span class="comment">// TODO maybe we should interpolate this back to &#39;now&#39;?</span></div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>                <span class="keywordflow">if</span> (Vector3.Distance(state.position, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.position) &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">positionCorrectionThreshold</a>)</div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>                {</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>                    <span class="keywordtype">double</span> ahead = state.timestamp - newest.timestamp;</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>                    <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.Log($<span class="stringliteral">&quot;Hard correction because the client is ahead of the server by {(ahead*1000):F1}ms. History of size={stateHistory.Count} @ t={timestamp:F3} oldest={oldest.timestamp:F3} newest={newest.timestamp:F3}. This can happen when latency is near zero, and is fine unless it shows jitter.&quot;</span>);</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>                    ApplyState(state.timestamp, state.position, state.rotation, state.velocity, state.angularVelocity);</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>                }</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>            }</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span> </div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>            <span class="comment">// find the two closest client states between timestamp</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>            <span class="keywordflow">if</span> (!Prediction.Sample(stateHistory, timestamp, out RigidbodyState before, out RigidbodyState after, out <span class="keywordtype">int</span> afterIndex, out <span class="keywordtype">double</span> t))</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>            {</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>                <span class="comment">// something went very wrong. sampling should&#39;ve worked.</span></div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>                <span class="comment">// hard correct to recover the error.</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>                <a class="code hl_typedef" href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a>.LogError($<span class="stringliteral">&quot;Failed to sample history of size={stateHistory.Count} @ t={timestamp:F3} oldest={oldest.timestamp:F3} newest={newest.timestamp:F3}. This should never happen because the timestamp is within history.&quot;</span>);</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>                ApplyState(state.timestamp, state.position, state.rotation, state.velocity, state.angularVelocity);</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>            }</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span> </div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span>            <span class="comment">// interpolate between them to get the best approximation</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span>            RigidbodyState interpolated = RigidbodyState.Interpolate(before, after, (<span class="keywordtype">float</span>)t);</div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span> </div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>            <span class="comment">// calculate the difference between where we were and where we should be</span></div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>            <span class="comment">// TODO only position for now. consider rotation etc. too later</span></div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>            <span class="keywordtype">float</span> positionDifference = Vector3.Distance(state.position, interpolated.position);</div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>            <span class="keywordtype">float</span> rotationDifference = Quaternion.Angle(state.rotation, interpolated.rotation);</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>            <span class="comment">// Debug.Log($&quot;Sampled history of size={stateHistory.Count} @ {timestamp:F3}: client={interpolated.position} server={state.position} difference={difference:F3} / {correctionThreshold:F3}&quot;);</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span> </div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>            <span class="comment">// too far off? then correct it</span></div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>            <span class="keywordflow">if</span> (positionDifference &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">positionCorrectionThreshold</a> ||</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>                rotationDifference &gt;= <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">rotationCorrectionThreshold</a>)</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>            {</div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>                <span class="comment">// Debug.Log($&quot;CORRECTION NEEDED FOR {name} @ {timestamp:F3}: client={interpolated.position} server={state.position} difference={difference:F3}&quot;);</span></div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span> </div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>                <span class="comment">// show the received correction position + velocity for debugging.</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>                <span class="comment">// helps to compare with the interpolated/applied correction locally.</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>                <span class="comment">//Debug.DrawLine(state.position, state.position + state.velocity * 0.1f, Color.white, lineTime);</span></div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span> </div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>                <span class="comment">// insert the correction and correct the history on top of it.</span></div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>                <span class="comment">// returns the final recomputed state after rewinding.</span></div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>                RigidbodyState recomputed = Prediction.CorrectHistory(stateHistory, <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">stateHistoryLimit</a>, state, before, after, afterIndex);</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span> </div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>                <span class="comment">// log, draw &amp; apply the final position.</span></div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>                <span class="comment">// always do this here, not when iterating above, in case we aren&#39;t iterating.</span></div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>                <span class="comment">// for example, on same machine with near zero latency.</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>                <span class="comment">// int correctedAmount = stateHistory.Count - afterIndex;</span></div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>                <span class="comment">// Debug.Log($&quot;Correcting {name}: {correctedAmount} / {stateHistory.Count} states to final position from: {rb.position} to: {last.position}&quot;);</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>                <span class="comment">//Debug.DrawLine(physicsCopyRigidbody.position, recomputed.position, Color.green, lineTime);</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>                ApplyState(recomputed.timestamp, recomputed.position, recomputed.rotation, recomputed.velocity, recomputed.angularVelocity);</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span> </div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>                <span class="comment">// user callback</span></div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>                <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a5ebeb25d2575a1bc094d150979328922">OnCorrected</a>();</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>            }</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>        }</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span> </div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>        <span class="comment">// send state to clients every sendInterval.</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>        <span class="comment">// reliable for now.</span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>        <span class="comment">// TODO we should use the one from FixedUpdate</span></div>
<div class="foldopen" id="foldopen00738" data-start="{" data-end="}">
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a229f42a6155bd8e3970edb916c99f799">  738</a></span>        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a229f42a6155bd8e3970edb916c99f799">OnSerialize</a>(<a class="code hl_class" href="class_mirror_1_1_network_writer.html">NetworkWriter</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>, <span class="keywordtype">bool</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">initialState</a>)</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>        {</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>            <span class="comment">// Time.time was at the beginning of this frame.</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>            <span class="comment">// NetworkLateUpdate-&gt;Broadcast-&gt;OnSerialize is at the end of the frame.</span></div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>            <span class="comment">// as result, client should use this to correct the _next_ frame.</span></div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>            <span class="comment">// otherwise we see noticeable resets that seem off by one frame.</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>            <span class="comment">//</span></div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>            <span class="comment">// to solve this, we can send the current deltaTime.</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>            <span class="comment">// server is technically supposed to be at a fixed frame rate, but this can vary.</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>            <span class="comment">// sending server&#39;s current deltaTime is the safest option.</span></div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>            <span class="comment">// client then applies it on top of remoteTimestamp.</span></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span> </div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span> </div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>            <span class="comment">// FAST VERSION: this shows in profiler a lot, so cache EVERYTHING!</span></div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>            tf.GetPositionAndRotation(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> position, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> rotation);  <span class="comment">// faster than tf.position + tf.rotation. server&#39;s rigidbody is on the same transform.</span></div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>.WriteFloat(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Time</a>.deltaTime);</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>.WriteVector3(position);</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>.WriteQuaternion(rotation);</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>.WriteVector3(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.velocity);</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">writer</a>.WriteVector3(<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>.angularVelocity);</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>        }</div>
</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span> </div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>        <span class="comment">// read the server&#39;s state, compare with client state &amp; correct if necessary.</span></div>
<div class="foldopen" id="foldopen00761" data-start="{" data-end="}">
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a4a21e63ebeff9544a11420ddd99f6cd2">  761</a></span>        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a4a21e63ebeff9544a11420ddd99f6cd2">OnDeserialize</a>(<a class="code hl_class" href="class_mirror_1_1_network_reader.html">NetworkReader</a> reader, <span class="keywordtype">bool</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">initialState</a>)</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>        {</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>            <span class="comment">// deserialize data</span></div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>            <span class="comment">// we want to know the time on the server when this was sent, which is remoteTimestamp.</span></div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>            <span class="keywordtype">double</span> timestamp = NetworkClient.connection.remoteTimeStamp;</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span> </div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>            <span class="comment">// server send state at the end of the frame.</span></div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>            <span class="comment">// parse and apply the server&#39;s delta time to our timestamp.</span></div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>            <span class="comment">// otherwise we see noticeable resets that seem off by one frame.</span></div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>            <span class="keywordtype">double</span> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">serverDeltaTime</a> = reader.ReadFloat();</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>            timestamp += <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">serverDeltaTime</a>;</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span> </div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>            <span class="comment">// however, adding yet one more frame delay gives much(!) better results.</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>            <span class="comment">// we don&#39;t know why yet, so keep this as an option for now.</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>            <span class="comment">// possibly because client captures at the beginning of the frame,</span></div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>            <span class="comment">// with physics happening at the end of the frame?</span></div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#ab66167ae8946ea0487a06118cd96b102">oneFrameAhead</a>) timestamp += <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">serverDeltaTime</a>;</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span> </div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>            <span class="comment">// parse state</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> position        = reader.ReadVector3();</div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a> rotation     = reader.ReadQuaternion();</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> velocity        = reader.ReadVector3();</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a> angularVelocity = reader.ReadVector3();</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span> </div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>            <span class="comment">// process received state</span></div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>            OnReceivedState(timestamp, <span class="keyword">new</span> <a class="code hl_struct" href="struct_mirror_1_1_rigidbody_state.html">RigidbodyState</a>(timestamp, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a>.zero, position, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Quaternion</a>.identity, rotation, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a>.zero, velocity, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Vector3</a>.zero, angularVelocity));</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>        }</div>
</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span> </div>
<div class="foldopen" id="foldopen00789" data-start="{" data-end="}">
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a21380f4e4b163b9e22c64550f7e65eab">  789</a></span>        <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a21380f4e4b163b9e22c64550f7e65eab">OnValidate</a>()</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>        {</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>            <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">base</a>.OnValidate();</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span> </div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>            <span class="comment">// force syncDirection to be ServerToClient</span></div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>            <a class="code hl_variable" href="class_mirror_1_1_network_behaviour.html#a3e6dfe7de8eac46346abcc3153c6a0c8">syncDirection</a> = <a class="code hl_enumeration" href="namespace_mirror.html#a3a4f3784dd23e16377d46532b14bae88">SyncDirection</a>.ServerToClient;</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span> </div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>            <span class="comment">// state should be synced immediately for now.</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>            <span class="comment">// later when we have prediction fully dialed in,</span></div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>            <span class="comment">// then we can maybe relax this a bit.</span></div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>            <a class="code hl_variable" href="class_mirror_1_1_network_behaviour.html#a94dbe38f0930d3bbde326d0eed7b6f83">syncInterval</a> = 0;</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>        }</div>
</div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span> </div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>        <span class="comment">// helper function for Physics tests to check if a Rigidbody belongs to</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>        <span class="comment">// a PredictedRigidbody component (either on it, or on its ghost).</span></div>
<div class="foldopen" id="foldopen00804" data-start="{" data-end="}">
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#a3d2c7b4812a43d9ef726c59ba31fed60">  804</a></span>        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#a3d2c7b4812a43d9ef726c59ba31fed60">IsPredicted</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Rigidbody</a> rb, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody.html">PredictedRigidbody</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>)</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>        {</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>            <span class="comment">// by default, Rigidbody is on the PredictedRigidbody GameObject</span></div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>            <span class="keywordflow">if</span> (rb.TryGetComponent(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>))</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span> </div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>            <span class="comment">// it might be on a ghost while interacting</span></div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>            <span class="keywordflow">if</span> (rb.TryGetComponent(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">PredictedRigidbodyPhysicsGhost</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a>))</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>            {</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>                <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a>.target.GetComponent&lt;<a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody.html">PredictedRigidbody</a>&gt;();</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>            }</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span> </div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>            <span class="comment">// otherwise the Rigidbody does not belong to any PredictedRigidbody.</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>        }</div>
</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span> </div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>        <span class="comment">// helper function for Physics tests to check if a Collider (which may be in children) belongs to</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>        <span class="comment">// a PredictedRigidbody component (either on it, or on its ghost).</span></div>
<div class="foldopen" id="foldopen00824" data-start="{" data-end="}">
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno"><a class="line" href="class_mirror_1_1_predicted_rigidbody.html#abbd3c1ee72eef9a36d25699462f99993">  824</a></span>        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="class_mirror_1_1_predicted_rigidbody.html#abbd3c1ee72eef9a36d25699462f99993">IsPredicted</a>(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">Collider</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">co</a>, <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody.html">PredictedRigidbody</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>)</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>        {</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>            <span class="comment">// by default, Collider is on the PredictedRigidbody GameObject or it&#39;s children.</span></div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">co</a>.GetComponentInParent&lt;<a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody.html">PredictedRigidbody</a>&gt;();</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> != <span class="keyword">null</span>)</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span> </div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>            <span class="comment">// it might be on a ghost while interacting</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>            <a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">PredictedRigidbodyPhysicsGhost</a> <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a> = <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">co</a>.GetComponentInParent&lt;<a class="code hl_class" href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">PredictedRigidbodyPhysicsGhost</a>&gt;();</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>            <span class="keywordflow">if</span> (<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a> != <span class="keyword">null</span> &amp;&amp; <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a>.target != <span class="keyword">null</span> &amp;&amp; <a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">ghost</a>.target.TryGetComponent(<a class="code hl_struct" href="struct_mirror_1_1_grid2_d.html">out</a> <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a>))</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span> </div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>            <span class="comment">// otherwise the Rigidbody does not belong to any PredictedRigidbody.</span></div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>            <a class="code hl_variable" href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">predictedRigidbody</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>        }</div>
</div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>    }</div>
</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>}</div>
<div class="ttc" id="a_worker_thread_8cs_html_a0100be52d45f14348918ea69ec09f959"><div class="ttname"><a href="_worker_thread_8cs.html#a0100be52d45f14348918ea69ec09f959">Debug</a></div><div class="ttdeci">UnityEngine.Debug Debug</div><div class="ttdef"><b>Definition</b> <a href="_worker_thread_8cs_source.html#l00008">WorkerThread.cs:8</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html">Mirror.NetworkBehaviour</a></div><div class="ttdoc">Base class for networked components.</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00025">NetworkBehaviour.cs:26</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html_a3e6dfe7de8eac46346abcc3153c6a0c8"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html#a3e6dfe7de8eac46346abcc3153c6a0c8">Mirror.NetworkBehaviour.syncDirection</a></div><div class="ttdeci">SyncDirection syncDirection</div><div class="ttdoc">Sync direction for OnSerialize. ServerToClient by default. ClientToServer for client authority.</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00029">NetworkBehaviour.cs:29</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html_a6a65dec5ade34544074c2f997932e17a"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html#a6a65dec5ade34544074c2f997932e17a">Mirror.NetworkBehaviour.isServer</a></div><div class="ttdeci">bool isServer</div><div class="ttdoc">True if this object is on the server and has been spawned.</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00052">NetworkBehaviour.cs:52</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html_a94dbe38f0930d3bbde326d0eed7b6f83"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html#a94dbe38f0930d3bbde326d0eed7b6f83">Mirror.NetworkBehaviour.syncInterval</a></div><div class="ttdeci">float syncInterval</div><div class="ttdoc">sync interval for OnSerialize (in seconds)</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00046">NetworkBehaviour.cs:46</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html_aa54c7efe36af763380824091dd7e6159"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html#aa54c7efe36af763380824091dd7e6159">Mirror.NetworkBehaviour.SetDirty</a></div><div class="ttdeci">void SetDirty()</div><div class="ttdoc">Set as dirty to trigger OnSerialize &amp; send. Dirty bits are cleared after the send.</div></div>
<div class="ttc" id="aclass_mirror_1_1_network_behaviour_html_abe78215943243c0ee91c2bd9a0057915"><div class="ttname"><a href="class_mirror_1_1_network_behaviour.html#abe78215943243c0ee91c2bd9a0057915">Mirror.NetworkBehaviour.isClientOnly</a></div><div class="ttdeci">bool isClientOnly</div><div class="ttdoc">True if this object is on the client-only, not host.</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00064">NetworkBehaviour.cs:64</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_reader_html"><div class="ttname"><a href="class_mirror_1_1_network_reader.html">Mirror.NetworkReader</a></div><div class="ttdoc">Network Reader for most simple types like floats, ints, buffers, structs, etc. Use NetworkReaderPool....</div><div class="ttdef"><b>Definition</b> <a href="_network_reader_8cs_source.html#l00018">NetworkReader.cs:19</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_network_writer_html"><div class="ttname"><a href="class_mirror_1_1_network_writer.html">Mirror.NetworkWriter</a></div><div class="ttdoc">Network Writer for most simple types like floats, ints, buffers, structs, etc. Use NetworkWriterPool....</div><div class="ttdef"><b>Definition</b> <a href="_network_writer_8cs_source.html#l00010">NetworkWriter.cs:11</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html">Mirror.PredictedRigidbody</a></div><div class="ttdef"><b>Definition</b> <a href="#l00024">PredictedRigidbody.cs:25</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a05655dd23d2f05cdae465414bb141ab0"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a05655dd23d2f05cdae465414bb141ab0">Mirror.PredictedRigidbody.reduceSendsWhileIdle</a></div><div class="ttdeci">bool reduceSendsWhileIdle</div><div class="ttdef"><b>Definition</b> <a href="#l00089">PredictedRigidbody.cs:89</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a0f940c8a77f7c4d8f0874f44013be8cd"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a0f940c8a77f7c4d8f0874f44013be8cd">Mirror.PredictedRigidbody.snapThreshold</a></div><div class="ttdeci">float snapThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00068">PredictedRigidbody.cs:68</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a16bc356fed132824658329e06f2c0b25"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a16bc356fed132824658329e06f2c0b25">Mirror.PredictedRigidbody.stateHistoryLimit</a></div><div class="ttdeci">int stateHistoryLimit</div><div class="ttdef"><b>Definition</b> <a href="#l00044">PredictedRigidbody.cs:44</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a21380f4e4b163b9e22c64550f7e65eab"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a21380f4e4b163b9e22c64550f7e65eab">Mirror.PredictedRigidbody.OnValidate</a></div><div class="ttdeci">override void OnValidate()</div><div class="ttdef"><b>Definition</b> <a href="#l00789">PredictedRigidbody.cs:789</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a221d2e3f34f78172121f127f063a968b"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a221d2e3f34f78172121f127f063a968b">Mirror.PredictedRigidbody.positionCorrectionThreshold</a></div><div class="ttdeci">double positionCorrectionThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00056">PredictedRigidbody.cs:56</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a229f42a6155bd8e3970edb916c99f799"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a229f42a6155bd8e3970edb916c99f799">Mirror.PredictedRigidbody.OnSerialize</a></div><div class="ttdeci">override void OnSerialize(NetworkWriter writer, bool initialState)</div><div class="ttdoc">Override to do custom serialization (instead of SyncVars/SyncLists). Use OnDeserialize too.</div><div class="ttdef"><b>Definition</b> <a href="#l00738">PredictedRigidbody.cs:738</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a23fabf6d88f9475bbd3ff9140d66d219"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a23fabf6d88f9475bbd3ff9140d66d219">Mirror.PredictedRigidbody.physicsCopy</a></div><div class="ttdeci">GameObject physicsCopy</div><div class="ttdef"><b>Definition</b> <a href="#l00096">PredictedRigidbody.cs:96</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a26bc336e1f0d219c2a7a0e956b9ec7e9"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a26bc336e1f0d219c2a7a0e956b9ec7e9">Mirror.PredictedRigidbody.onlyRecordChanges</a></div><div class="ttdeci">bool onlyRecordChanges</div><div class="ttdef"><b>Definition</b> <a href="#l00049">PredictedRigidbody.cs:49</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a347c9c40c7ef8ea739b8e1453485eec6"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a347c9c40c7ef8ea739b8e1453485eec6">Mirror.PredictedRigidbody.predictedRigidbody</a></div><div class="ttdeci">Rigidbody predictedRigidbody</div><div class="ttdef"><b>Definition</b> <a href="#l00027">PredictedRigidbody.cs:27</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a358f16bc1a6a3b03b7c2633388ad3725"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a358f16bc1a6a3b03b7c2633388ad3725">Mirror.PredictedRigidbody.OnBeginPrediction</a></div><div class="ttdeci">virtual void OnBeginPrediction()</div><div class="ttdef"><b>Definition</b> <a href="#l00523">PredictedRigidbody.cs:523</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a37d15d3015751972aaa28e129ca2fceb"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a37d15d3015751972aaa28e129ca2fceb">Mirror.PredictedRigidbody.correctionMode</a></div><div class="ttdeci">CorrectionMode correctionMode</div><div class="ttdef"><b>Definition</b> <a href="#l00065">PredictedRigidbody.cs:65</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a3ce5d2452b149ad47d6303773dd5e996"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a3ce5d2452b149ad47d6303773dd5e996">Mirror.PredictedRigidbody.CreateGhosts</a></div><div class="ttdeci">virtual void CreateGhosts()</div><div class="ttdef"><b>Definition</b> <a href="#l00159">PredictedRigidbody.cs:159</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a3d2c7b4812a43d9ef726c59ba31fed60"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a3d2c7b4812a43d9ef726c59ba31fed60">Mirror.PredictedRigidbody.IsPredicted</a></div><div class="ttdeci">static bool IsPredicted(Rigidbody rb, out PredictedRigidbody predictedRigidbody)</div><div class="ttdef"><b>Definition</b> <a href="#l00804">PredictedRigidbody.cs:804</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a451891693927acf67bde95796ff162aa"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a451891693927acf67bde95796ff162aa">Mirror.PredictedRigidbody.positionInterpolationSpeed</a></div><div class="ttdeci">float positionInterpolationSpeed</div><div class="ttdef"><b>Definition</b> <a href="#l00081">PredictedRigidbody.cs:81</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a4a21e63ebeff9544a11420ddd99f6cd2"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a4a21e63ebeff9544a11420ddd99f6cd2">Mirror.PredictedRigidbody.OnDeserialize</a></div><div class="ttdeci">override void OnDeserialize(NetworkReader reader, bool initialState)</div><div class="ttdoc">Override to do custom deserialization (instead of SyncVars/SyncLists). Use OnSerialize too.</div><div class="ttdef"><b>Definition</b> <a href="#l00761">PredictedRigidbody.cs:761</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a4b0638c775c7df2323cf9ea013e17414"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a4b0638c775c7df2323cf9ea013e17414">Mirror.PredictedRigidbody.IsMoving</a></div><div class="ttdeci">virtual bool IsMoving()</div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a5ebeb25d2575a1bc094d150979328922"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a5ebeb25d2575a1bc094d150979328922">Mirror.PredictedRigidbody.OnCorrected</a></div><div class="ttdeci">virtual void OnCorrected()</div><div class="ttdef"><b>Definition</b> <a href="#l00522">PredictedRigidbody.cs:522</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a6138574f8eaee70b94d46068ba86aa6c"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a6138574f8eaee70b94d46068ba86aa6c">Mirror.PredictedRigidbody.CopyRenderersAsGhost</a></div><div class="ttdeci">virtual void CopyRenderersAsGhost(GameObject destination, Material material)</div><div class="ttdef"><b>Definition</b> <a href="#l00126">PredictedRigidbody.cs:126</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a6ddaaa078711aee9b5b53aea8c72713c"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a6ddaaa078711aee9b5b53aea8c72713c">Mirror.PredictedRigidbody.OnStopClient</a></div><div class="ttdeci">override void OnStopClient()</div><div class="ttdoc">Stop event, only called on client and host.</div><div class="ttdef"><b>Definition</b> <a href="#l00335">PredictedRigidbody.cs:335</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a74ac82a408e524d80aaf889b76c343b8"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a74ac82a408e524d80aaf889b76c343b8">Mirror.PredictedRigidbody.OnEndPrediction</a></div><div class="ttdeci">virtual void OnEndPrediction()</div><div class="ttdef"><b>Definition</b> <a href="#l00524">PredictedRigidbody.cs:524</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a85d2925f2e1cedbd161cc6049950a6d2"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a85d2925f2e1cedbd161cc6049950a6d2">Mirror.PredictedRigidbody.remoteCopy</a></div><div class="ttdeci">GameObject remoteCopy</div><div class="ttdef"><b>Definition</b> <a href="#l00103">PredictedRigidbody.cs:103</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a8fed6c6001716793e550247258c434fd"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a8fed6c6001716793e550247258c434fd">Mirror.PredictedRigidbody.motionSmoothingTimeTolerance</a></div><div class="ttdeci">float motionSmoothingTimeTolerance</div><div class="ttdef"><b>Definition</b> <a href="#l00037">PredictedRigidbody.cs:37</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a93a51eb03d3e2ee26abb482e1cc934a1"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a93a51eb03d3e2ee26abb482e1cc934a1">Mirror.PredictedRigidbody.DestroyGhosts</a></div><div class="ttdeci">virtual void DestroyGhosts()</div><div class="ttdef"><b>Definition</b> <a href="#l00233">PredictedRigidbody.cs:233</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a94b10093bf267fa52ed3b760932b9ff0"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a94b10093bf267fa52ed3b760932b9ff0">Mirror.PredictedRigidbody.rotationInterpolationSpeed</a></div><div class="ttdeci">float rotationInterpolationSpeed</div><div class="ttdef"><b>Definition</b> <a href="#l00082">PredictedRigidbody.cs:82</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_a9b5380d587def5e6ce8e0307811b16ad"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#a9b5380d587def5e6ce8e0307811b16ad">Mirror.PredictedRigidbody.lineTime</a></div><div class="ttdeci">float lineTime</div><div class="ttdef"><b>Definition</b> <a href="#l00092">PredictedRigidbody.cs:92</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_aa45dcf59c72f261b3a99851e114725e1"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#aa45dcf59c72f261b3a99851e114725e1">Mirror.PredictedRigidbody.remoteGhostMaterial</a></div><div class="ttdeci">Material remoteGhostMaterial</div><div class="ttdef"><b>Definition</b> <a href="#l00078">PredictedRigidbody.cs:78</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_aab15a1bbe0c3650fda416a9762a7e077"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#aab15a1bbe0c3650fda416a9762a7e077">Mirror.PredictedRigidbody.ghostVelocityThreshold</a></div><div class="ttdeci">float ghostVelocityThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00074">PredictedRigidbody.cs:74</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_ab377b2ce608f0727fced6f787b738df2"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#ab377b2ce608f0727fced6f787b738df2">Mirror.PredictedRigidbody.SmoothFollowPhysicsCopy</a></div><div class="ttdeci">virtual void SmoothFollowPhysicsCopy()</div><div class="ttdef"><b>Definition</b> <a href="#l00272">PredictedRigidbody.cs:272</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_ab66167ae8946ea0487a06118cd96b102"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#ab66167ae8946ea0487a06118cd96b102">Mirror.PredictedRigidbody.oneFrameAhead</a></div><div class="ttdeci">bool oneFrameAhead</div><div class="ttdef"><b>Definition</b> <a href="#l00061">PredictedRigidbody.cs:61</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_abb5e093726a09cab3d11ad3b5de74dd7"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#abb5e093726a09cab3d11ad3b5de74dd7">Mirror.PredictedRigidbody.localGhostMaterial</a></div><div class="ttdeci">Material localGhostMaterial</div><div class="ttdef"><b>Definition</b> <a href="#l00077">PredictedRigidbody.cs:77</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_abbd3c1ee72eef9a36d25699462f99993"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#abbd3c1ee72eef9a36d25699462f99993">Mirror.PredictedRigidbody.IsPredicted</a></div><div class="ttdeci">static bool IsPredicted(Collider co, out PredictedRigidbody predictedRigidbody)</div><div class="ttdef"><b>Definition</b> <a href="#l00824">PredictedRigidbody.cs:824</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_abe59d76bbe0604bbc53de7fc371bd035"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#abe59d76bbe0604bbc53de7fc371bd035">Mirror.PredictedRigidbody.recordInterval</a></div><div class="ttdeci">float recordInterval</div><div class="ttdef"><b>Definition</b> <a href="#l00046">PredictedRigidbody.cs:46</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_ac51e050040b89552736e77d4f776d5bb"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#ac51e050040b89552736e77d4f776d5bb">Mirror.PredictedRigidbody.OnBeforeApplyState</a></div><div class="ttdeci">virtual void OnBeforeApplyState()</div><div class="ttdef"><b>Definition</b> <a href="#l00521">PredictedRigidbody.cs:521</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_ac63f7f4da37a261f1dda73bd63037b88"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#ac63f7f4da37a261f1dda73bd63037b88">Mirror.PredictedRigidbody.rotationCorrectionThreshold</a></div><div class="ttdeci">double rotationCorrectionThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00058">PredictedRigidbody.cs:58</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_acc83bd1d3591446eb7b72774fb59a0bc"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#acc83bd1d3591446eb7b72774fb59a0bc">Mirror.PredictedRigidbody.teleportDistanceMultiplier</a></div><div class="ttdeci">float teleportDistanceMultiplier</div><div class="ttdef"><b>Definition</b> <a href="#l00085">PredictedRigidbody.cs:85</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_accaf0a01fabce1bf8de5e801923ed7b7"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#accaf0a01fabce1bf8de5e801923ed7b7">Mirror.PredictedRigidbody.compareLastFirst</a></div><div class="ttdeci">bool compareLastFirst</div><div class="ttdef"><b>Definition</b> <a href="#l00052">PredictedRigidbody.cs:52</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_adc9aa75aa188156854ec99877a0e96cc"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#adc9aa75aa188156854ec99877a0e96cc">Mirror.PredictedRigidbody.motionSmoothingAngularVelocityThreshold</a></div><div class="ttdeci">float motionSmoothingAngularVelocityThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00036">PredictedRigidbody.cs:36</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_aebdd7fea91a87e82a1fde56a3ab1f9d9"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#aebdd7fea91a87e82a1fde56a3ab1f9d9">Mirror.PredictedRigidbody.OnSnappedIntoPlace</a></div><div class="ttdeci">virtual void OnSnappedIntoPlace()</div><div class="ttdef"><b>Definition</b> <a href="#l00520">PredictedRigidbody.cs:520</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_aef2f46ee84b63441be12cc9decbd04f0"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#aef2f46ee84b63441be12cc9decbd04f0">Mirror.PredictedRigidbody.motionSmoothingVelocityThreshold</a></div><div class="ttdeci">float motionSmoothingVelocityThreshold</div><div class="ttdef"><b>Definition</b> <a href="#l00035">PredictedRigidbody.cs:35</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_html_af6f4eaf410feb856ddb6dd3d268acebc"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody.html#af6f4eaf410feb856ddb6dd3d268acebc">Mirror.PredictedRigidbody.showGhost</a></div><div class="ttdeci">bool showGhost</div><div class="ttdef"><b>Definition</b> <a href="#l00072">PredictedRigidbody.cs:72</a></div></div>
<div class="ttc" id="aclass_mirror_1_1_predicted_rigidbody_physics_ghost_html"><div class="ttname"><a href="class_mirror_1_1_predicted_rigidbody_physics_ghost.html">Mirror.PredictedRigidbodyPhysicsGhost</a></div><div class="ttdef"><b>Definition</b> <a href="_predicted_rigidbody_physics_ghost_8cs_source.html#l00008">PredictedRigidbodyPhysicsGhost.cs:9</a></div></div>
<div class="ttc" id="anamespace_mirror_html"><div class="ttname"><a href="namespace_mirror.html">Mirror</a></div><div class="ttdef"><b>Definition</b> <a href="_basic_authenticator_8cs_source.html#l00005">BasicAuthenticator.cs:6</a></div></div>
<div class="ttc" id="anamespace_mirror_html_a3a4f3784dd23e16377d46532b14bae88"><div class="ttname"><a href="namespace_mirror.html#a3a4f3784dd23e16377d46532b14bae88">Mirror.SyncDirection</a></div><div class="ttdeci">SyncDirection</div><div class="ttdef"><b>Definition</b> <a href="_network_behaviour_8cs_source.html#l00019">NetworkBehaviour.cs:19</a></div></div>
<div class="ttc" id="anamespace_mirror_html_a9431b82fe2d4ded8b690baf4d0b378cc"><div class="ttname"><a href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cc">Mirror.CorrectionMode</a></div><div class="ttdeci">CorrectionMode</div><div class="ttdef"><b>Definition</b> <a href="#l00017">PredictedRigidbody.cs:18</a></div></div>
<div class="ttc" id="anamespace_mirror_html_a9431b82fe2d4ded8b690baf4d0b378cca5d5b78699e57104f2fa03bbdf7b9197b"><div class="ttname"><a href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cca5d5b78699e57104f2fa03bbdf7b9197b">Mirror.CorrectionMode.Set</a></div><div class="ttdeci">@ Set</div></div>
<div class="ttc" id="anamespace_mirror_html_a9431b82fe2d4ded8b690baf4d0b378cca6bc362dbf494c61ea117fe3c71ca48a5"><div class="ttname"><a href="namespace_mirror.html#a9431b82fe2d4ded8b690baf4d0b378cca6bc362dbf494c61ea117fe3c71ca48a5">Mirror.CorrectionMode.Move</a></div><div class="ttdeci">@ Move</div></div>
<div class="ttc" id="astruct_mirror_1_1_grid2_d_html"><div class="ttname"><a href="struct_mirror_1_1_grid2_d.html">Mirror.Grid2D</a></div><div class="ttdef"><b>Definition</b> <a href="_grid2_d_8cs_source.html#l00010">Grid2D.cs:11</a></div></div>
<div class="ttc" id="astruct_mirror_1_1_grid2_d_html_a05b810f7466b59b26b243d83383d1274"><div class="ttname"><a href="struct_mirror_1_1_grid2_d.html#a05b810f7466b59b26b243d83383d1274">Mirror.Grid2D.Add</a></div><div class="ttdeci">void Add(Vector2Int position, T value)</div><div class="ttdef"><b>Definition</b> <a href="_grid2_d_8cs_source.html#l00044">Grid2D.cs:44</a></div></div>
<div class="ttc" id="astruct_mirror_1_1_rigidbody_state_html"><div class="ttname"><a href="struct_mirror_1_1_rigidbody_state.html">Mirror.RigidbodyState</a></div><div class="ttdef"><b>Definition</b> <a href="_rigidbody_state_8cs_source.html#l00006">RigidbodyState.cs:7</a></div></div>
<div class="ttc" id="astruct_mirror_1_1_rigidbody_state_html_a3df152c12ab9502420a32603e90bf729"><div class="ttname"><a href="struct_mirror_1_1_rigidbody_state.html#a3df152c12ab9502420a32603e90bf729">Mirror.RigidbodyState.position</a></div><div class="ttdeci">Vector3 position</div><div class="ttdef"><b>Definition</b> <a href="_rigidbody_state_8cs_source.html#l00013">RigidbodyState.cs:13</a></div></div>
<div class="ttc" id="astruct_mirror_1_1_rigidbody_state_html_aa40b806423fc55ce208b7b1ec726edae"><div class="ttname"><a href="struct_mirror_1_1_rigidbody_state.html#aa40b806423fc55ce208b7b1ec726edae">Mirror.RigidbodyState.rotation</a></div><div class="ttdeci">Quaternion rotation</div><div class="ttdef"><b>Definition</b> <a href="_rigidbody_state_8cs_source.html#l00016">RigidbodyState.cs:16</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_84bbf7b3c7f28a5a18725745e1505219.html">Assets</a></li><li class="navelem"><a class="el" href="dir_bf1dd3994e8f933eb733da65a1863113.html">Mirror</a></li><li class="navelem"><a class="el" href="dir_5065f1081954be9815f50aa7556b37df.html">Components</a></li><li class="navelem"><a class="el" href="dir_d5c857f0edea5fb7c1cddaf12d91b509.html">PredictedRigidbody</a></li><li class="navelem"><a class="el" href="_predicted_rigidbody_8cs.html">PredictedRigidbody.cs</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
